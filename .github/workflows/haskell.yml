name: Haskell CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: write

jobs:
  build-linux:
    name: Linux (Alpine/musl)
    runs-on: ubuntu-latest
    container:
      image: alpine:edge

    steps:
    - name: Install build dependencies
      run: |
        apk add --no-cache \
          curl \
          gcc \
          g++ \
          gmp-dev \
          ncurses-dev \
          libffi-dev \
          make \
          xz \
          tar \
          perl \
          bash \
          git \
          musl-dev \
          zlib-dev \
          zlib-static \
          binutils \
          binutils-gold \
          pkgconfig

    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install GHCup and Haskell toolchain
      run: |
        curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | \
          BOOTSTRAP_HASKELL_NONINTERACTIVE=1 \
          BOOTSTRAP_HASKELL_GHC_VERSION=latest \
          BOOTSTRAP_HASKELL_CABAL_VERSION=latest \
          sh

    - name: Cache
      uses: actions/cache@v3
      env:
        cache-name: cache-cabal-musl
      with:
        path: ~/.cabal
        key: alpine-build-${{ env.cache-name }}-${{ hashFiles('**/*.cabal') }}-${{ hashFiles('**/cabal.project') }}
        restore-keys: |
          alpine-build-${{ env.cache-name }}-
          alpine-build-

    - name: Build
      run: |
        . ~/.ghcup/env
        cabal update
        cabal build --enable-tests --enable-benchmarks \
          --ghc-options="-static -optl-static -optl-pthread"

    - name: Run tests
      continue-on-error: true
      run: |
        . ~/.ghcup/env
        cabal test

    - name: Prepare binary for release
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      run: |
        . ~/.ghcup/env
        mkdir -p release
        cp $(cabal list-bin haskbox) release/haskbox
        chmod +x release/haskbox
        strip --strip-all release/haskbox
        tar -czvf release/haskbox-linux-x86_64.tar.gz -C release haskbox
        rm release/haskbox

    - name: Upload Linux binary
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      uses: actions/upload-artifact@v4
      with:
        name: haskbox-linux-x86_64
        path: release/haskbox-linux-x86_64.tar.gz

  build-macos:
    name: macOS (latest)
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - uses: haskell-actions/setup@v2
      with:
        ghc-version: 'latest'
        cabal-version: 'latest'

    - name: Cache
      uses: actions/cache@v3
      env:
        cache-name: cache-cabal
      with:
        path: ~/.cabal
        key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/*.cabal') }}-${{ hashFiles('**/cabal.project') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ env.cache-name }}-
          ${{ runner.os }}-build-
          ${{ runner.os }}-

    - name: Install GNU coreutils
      run: brew install coreutils

    - name: Install dependencies
      run: |
        cabal update
        cabal build --only-dependencies --enable-tests --enable-benchmarks

    - name: Build
      run: cabal build

    - name: Run tests
      continue-on-error: true
      run: cabal test

    - name: Prepare binary for release
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      run: |
        mkdir -p release
        cp $(cabal list-bin haskbox) release/haskbox
        chmod +x release/haskbox
        tar -czvf release/haskbox-macos-arm64.tar.gz -C release haskbox
        rm release/haskbox

    - name: Upload macOS binary
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      uses: actions/upload-artifact@v4
      with:
        name: haskbox-macos-arm64
        path: release/haskbox-macos-arm64.tar.gz

  release:
    name: Create Release
    needs: [build-linux, build-macos]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get commit number
      id: commit_number
      run: |
        COMMIT_NUM=$(git rev-list --count HEAD)
        echo "number=$COMMIT_NUM" >> $GITHUB_OUTPUT
        echo "tag=b$COMMIT_NUM" >> $GITHUB_OUTPUT

    - name: Download Linux binary
      uses: actions/download-artifact@v4
      with:
        name: haskbox-linux-x86_64
        path: release/

    - name: Download macOS binary
      uses: actions/download-artifact@v4
      with:
        name: haskbox-macos-arm64
        path: release/

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.commit_number.outputs.tag }}
        name: Build ${{ steps.commit_number.outputs.number }}
        body: |
          Automated build from commit ${{ github.sha }}

          ## Downloads
          - `haskbox-linux-x86_64.tar.gz` - Linux (x86_64, musl-based static binary)
          - `haskbox-macos-arm64.tar.gz` - macOS (Apple Silicon)

          Extract with: `tar -xzf haskbox-<platform>.tar.gz`
        files: |
          release/haskbox-linux-x86_64.tar.gz
          release/haskbox-macos-arm64.tar.gz
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
